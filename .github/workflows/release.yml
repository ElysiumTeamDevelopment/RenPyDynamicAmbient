name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags starting with 'v' (e.g., v1.0.0)

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for creating releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper git log
        
      - name: Create release directory
        run: mkdir -p release
        
      - name: Copy files to release directory
        run: |
          cp ambient_auto_start.rpy release/
          cp ambient_config.rpy release/
          cp ambient_integration.rpy release/
          cp ambient_templates.rpy release/
          cp dynamic_ambient.rpy release/
          cp LICENSE release/
          cp README.md release/
          
      - name: Create zip archive
        run: |
          cd release
          zip -r ../RenPyDynamicAmbient-${{ github.ref_name }}.zip .
          cd ..
          
      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            echo "prev_tag=" >> $GITHUB_OUTPUT
          else
            echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate changelog
        id: changelog
        run: |
          DELIMITER=$(openssl rand -hex 8)
          echo "CHANGELOG<<$DELIMITER" >> $GITHUB_OUTPUT
          if [ -n "${{ steps.prev_tag.outputs.prev_tag }}" ]; then
            echo "### ðŸ”„ Changes since ${{ steps.prev_tag.outputs.prev_tag }}:" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s (%h)" ${{ steps.prev_tag.outputs.prev_tag }}..${{ github.ref_name }} | head -20 >> $GITHUB_OUTPUT
          else
            echo "### ðŸŽ‰ First release!" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "#### All commits in this release:" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s (%h)" | head -20 >> $GITHUB_OUTPUT
          fi
          echo "$DELIMITER" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          DELIMITER=$(openssl rand -hex 8)
          echo "RELEASE_NOTES<<$DELIMITER" >> $GITHUB_OUTPUT
          echo "## RenPy Dynamic Ambient ${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "${{ steps.changelog.outputs.CHANGELOG }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“¦ Included files:" >> $GITHUB_OUTPUT
          echo "- \`ambient_auto_start.rpy\` - auto-start ambient effects" >> $GITHUB_OUTPUT
          echo "- \`ambient_config.rpy\` - settings and configuration" >> $GITHUB_OUTPUT
          echo "- \`ambient_integration.rpy\` - RenPy integration" >> $GITHUB_OUTPUT
          echo "- \`ambient_templates.rpy\` - templates for creating effects" >> $GITHUB_OUTPUT
          echo "- \`dynamic_ambient.rpy\` - main module" >> $GITHUB_OUTPUT
          echo "- \`LICENSE\` - license file" >> $GITHUB_OUTPUT
          echo "- \`README.md\` - documentation" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Installation:" >> $GITHUB_OUTPUT
          echo "1. Download the \`RenPyDynamicAmbient-${{ github.ref_name }}.zip\` archive" >> $GITHUB_OUTPUT
          echo "2. Extract to the \`game/\` folder of your RenPy project" >> $GITHUB_OUTPUT
          echo "3. Restart the game to apply changes" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“– Documentation:" >> $GITHUB_OUTPUT
          echo "Detailed documentation is available in the README.md file" >> $GITHUB_OUTPUT
          echo "$DELIMITER" >> $GITHUB_OUTPUT
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "RenPy Dynamic Ambient ${{ github.ref_name }}"
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: RenPyDynamicAmbient-${{ github.ref_name }}.zip
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
