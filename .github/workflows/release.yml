name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags starting with 'v' (e.g., v1.0.0)

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for creating releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper git log
        
      - name: Create release directory
        run: |
          mkdir -p release
          mkdir -p release/libs/rpda
        
      - name: Copy files to release directory
        run: |
          cp ambient_auto_start.rpy release/
          cp ambient_integration.rpy release/
          cp dynamic_ambient.rpy release/
          cp debug_ambient.rpy release/
          cp audio_assets.yaml release/
          cp arrangements.yaml release/
          cp libs/rpda/02-rpda-cds.rpy release/libs/rpda/
          cp LICENSE release/
          cp README.md release/
          
      - name: Create zip archive
        run: |
          cd release
          zip -r ../RenPyDynamicAmbient-${{ github.ref_name }}.zip .
          cd ..
          
      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            echo "prev_tag=" >> $GITHUB_OUTPUT
          else
            echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate changelog
        run: |
          if [ -n "${{ steps.prev_tag.outputs.prev_tag }}" ]; then
            echo "## ðŸ”„ Changes since ${{ steps.prev_tag.outputs.prev_tag }}" > changelog.md
            echo "" >> changelog.md
            git log --pretty=format:"- %s (%h)" ${{ steps.prev_tag.outputs.prev_tag }}..${{ github.ref_name }} | head -20 >> changelog.md
          else
            echo "## ðŸŽ‰ First release!" > changelog.md
            echo "" >> changelog.md
            echo "### All commits in this release:" >> changelog.md
            git log --pretty=format:"- %s (%h)" | head -20 >> changelog.md
          fi
          echo "" >> changelog.md
          echo "### ðŸ“¦ Included files:" >> changelog.md
          echo "- \`dynamic_ambient.rpy\` - main module" >> changelog.md
          echo "- \`ambient_auto_start.rpy\` - auto-start ambient effects" >> changelog.md
          echo "- \`ambient_integration.rpy\` - RenPy integration" >> changelog.md
          echo "- \`debug_ambient.rpy\` - debug overlay" >> changelog.md
          echo "- \`audio_assets.yaml\` - audio assets configuration" >> changelog.md
          echo "- \`arrangements.yaml\` - arrangements configuration" >> changelog.md
          echo "- \`libs/rpda/02-rpda-cds.rpy\` - CDS implementation" >> changelog.md
          echo "- \`LICENSE\` - license file" >> changelog.md
          echo "- \`README.md\` - documentation" >> changelog.md
          echo "" >> changelog.md
          echo "### ðŸš€ Installation:" >> changelog.md
          echo "1. Download the \`RenPyDynamicAmbient-${{ github.ref_name }}.zip\` archive" >> changelog.md
          echo "2. Extract to the \`game/\` folder of your RenPy project" >> changelog.md
          echo "3. Restart the game to apply changes" >> changelog.md
          echo "" >> changelog.md
          echo "### ðŸ“– Documentation:" >> changelog.md
          echo "Detailed documentation is available in the README.md file" >> changelog.md
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "RenPy Dynamic Ambient ${{ github.ref_name }}"
          body_path: changelog.md
          files: RenPyDynamicAmbient-${{ github.ref_name }}.zip
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
