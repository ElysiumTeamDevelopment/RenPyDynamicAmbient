name: Release

on:
  push:
    tags:
      - 'v*'  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐ³Ð¾Ð² Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ñ…ÑÑ Ñ 'v' (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, v1.0.0)

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð¾Ð²
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Create release directory
        run: mkdir -p release
        
      - name: Copy files to release directory
        run: |
          cp ambient_auto_start.rpy release/
          cp ambient_config.rpy release/
          cp ambient_integration.rpy release/
          cp ambient_templates.rpy release/
          cp dynamic_ambient.rpy release/
          cp LICENSE release/
          cp README.md release/
          
      - name: Create zip archive
        run: |
          cd release
          zip -r ../RenPyDynamicAmbient-${{ github.ref_name }}.zip .
          cd ..
          
      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            echo "prev_tag=" >> $GITHUB_OUTPUT
          else
            echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate changelog
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          if [ -n "${{ steps.prev_tag.outputs.prev_tag }}" ]; then
            echo "### ðŸ”„ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ ${{ steps.prev_tag.outputs.prev_tag }}:" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s (%h)" ${{ steps.prev_tag.outputs.prev_tag }}..${{ github.ref_name }} | head -20 >> $GITHUB_OUTPUT
          else
            echo "### ðŸŽ‰ ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð·!" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ RenPy Dynamic Ambient Ð¼Ð¾Ð´ÑƒÐ»Ñ" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "## RenPy Dynamic Ambient ${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "${{ steps.changelog.outputs.CHANGELOG }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“¦ Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:" >> $GITHUB_OUTPUT
          echo "- \`ambient_auto_start.rpy\` - Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº ambient ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð²" >> $GITHUB_OUTPUT
          echo "- \`ambient_config.rpy\` - Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ" >> $GITHUB_OUTPUT
          echo "- \`ambient_integration.rpy\` - Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ RenPy" >> $GITHUB_OUTPUT
          echo "- \`ambient_templates.rpy\` - ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ‹ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð²" >> $GITHUB_OUTPUT
          echo "- \`dynamic_ambient.rpy\` - Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ" >> $GITHUB_OUTPUT
          echo "- \`LICENSE\` - Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ" >> $GITHUB_OUTPUT
          echo "- \`README.md\` - Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:" >> $GITHUB_OUTPUT
          echo "1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð² \`RenPyDynamicAmbient-${{ github.ref_name }}.zip\`" >> $GITHUB_OUTPUT
          echo "2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ Ð² Ð¿Ð°Ð¿ÐºÑƒ \`game/\` Ð²Ð°ÑˆÐµÐ³Ð¾ RenPy Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°" >> $GITHUB_OUTPUT
          echo "3. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¸Ð³Ñ€Ñƒ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“– Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ:" >> $GITHUB_OUTPUT
          echo "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð² Ñ„Ð°Ð¹Ð»Ðµ README.md" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "RenPy Dynamic Ambient ${{ github.ref_name }}"
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: RenPyDynamicAmbient-${{ github.ref_name }}.zip
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
